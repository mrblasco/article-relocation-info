```{r, include = FALSE}
library(dplyr)
library(kableExtra)
library(ggplot2)
library(ggtext)
#source("R/theme.R")

theme_set(theme_classic(base_size = 11))
theme_update(
    #panel.grid.major = element_line(linewidth = 0.35, linetype = "dashed", color = "gray"),
    axis.ticks.length = unit(-0.2, "cm"),
)

tab_dir <- file.path("results", "tables")
tables_rologit <- readRDS(file.path(tab_dir, "rologit_coeffs.rds"))
tbl_coeffs_hetero_raw <- readRDS(file.path(tab_dir, "rologit_coeffs_hetero.rds"))

tbl_coeffs_hetero <- tbl_coeffs_hetero_raw %>% 
    dplyr::select(estimate, std.error, condition, group_var, group, term) %>% 
    dplyr::mutate(
        baseline = condition == "Absolute",
        estimate = estimate - estimate[baseline],
        std.error = sqrt(std.error^2 + std.error[baseline]^2),
        .by = c(group_var, group, term)
    ) 
```

# Results

## Perceived fairness in the control group

Figure \@ref(fig:toprank) shows that, when asked to pick the fairest option, without information on the number of asylum seekers under each relocation scheme (i.e., the 'No Info' group), 74% of respondents selected some form of relocation as fairest, with a slight preference for relocation by GDP (39%) over relocation by population (35%). Only a minority (26%) considered no relocation at all to be the fairest option. A one-sample proportion test shows that this result is significantly lower (p<0.01) than the 33% expected if individuals were ranking alternatives at random or were indifferent among the options.

Figure \@ref(fig:toprank) also reveals considerable variation across countries. In Germany, only 58% in the ‘No info’ group ranked some form of relocation as the fairest option, which is the lowest share among the selected countries, while in Greece the proportion was highest at 87%. Relocation by GDP was commonly perceived as the fairest in Bulgaria (53%), Greece (48%) and Spain (48%), but not in Germany (19%) or Sweden (27%). Views on relocation by population also varied: the share of respondents assigning it the top rank range from 24% in Poland to 45% in Italy. These stark differences suggest that country-specific conditions, such as the political climate, refugee situation, and socio-economic differences, play a significant role in shaping public perceptions of fairness.

```{r toprank, fig.cap = full_cap, fig.scap = short_cap, fig.width = 7, fig.height = 3.5, out.width = "\\textwidth"}
short_cap <- "Fairest asylum-seeker allocation mechanism (Control)"
full_cap <- "Fairest asylum-seeker allocation mechanism: Top-ranked mechanism in the Control treatment, where respondents have no direct information about allocation consequences."
p <- readRDS(file.path("results", "figures", "top_rank_no_info.rds"))
```

## Average Treatment Effects on Fairness Rankings

Figure \@ref(fig:mean-rank) shows the mean differences in fairness rankings for the three allocation schemes (No relocation, Relocation by GDP, and Relocation by population), comparing respondents who were shown the number of relocated asylum seekers under each scheme (“Info: absolute”) with those who received no information (“no info”) and those who received the same information expressed in per-capita terms (“Info: relative”).

In countries that would experience more asylum seekers under the no-relocation scheme, such as Greece, Germany and Sweden, providing information about the number of asylum seekers caused a significant drop in the mean rank for no relocation compared to providing no information. By contrast, in countries that would receive relatively few asylum seekers under no relocation, such as Spain, Poland and Italy, providing this information significantly raised the average rank of the no-relocation option (by about 0.3). These results suggest that public perception of fairness is heavily influenced by information about the levels of asylum seekers and that the effect of such information depends on national interest: if relocation means more asylum seekers, information improves the perceived fairness of no relocation and vice versa. This evidence is consistent with our hypotheses that information plays a key role in shaping public perceptions of fairness of alternative relocation systems, and that countries will react differently to the same type of communication.

Figure \@ref(fig:mean-rank) also reveals significant differences in fairness rankings between the absolute- and relative-information conditions. In Spain, Poland, and Italy, the mean rank of no relocation increased significantly by 0.05 (one sixth the drop associated with no information), while in Germany it decreased by 0.03. These results confirm our hypotheses that individuals react not only to information, but they also react more when it is presented in absolute than in relative numbers. 

As a formal test of the overall associations between fairness rankings and treatment assignment, we used separate Chi-squared tests within each country with Bonferroni correction for multiple testing. Even after applying Bonferroni correction, all the country-specific associations were statistically significant (p. < 0.01), confirming a robust treatment effect in most countries, as hypothesised.

```{r mean-rank, fig.width = 7, fig.height = 7, fig.cap = cap, fig.scap = short_cap, out.width = "\\textwidth"}
short_cap <- "Mean differences in fairness rankings"
cap <- "Average differences and 95% confidence intervals in fairness rankings between individuals in the absolute-information group (baseline) and those in the relative- or no-information groups. A lower rank means a higher perceived fairness of the allocation mechanims. Statistically significant differences are highlighted."

p <- readRDS(file.path("results", "figures", "mean_rank.rds"))
```

## The role of asylum seekers 

We further investigate the role of the expected asylum seekers under each relocation scheme using a rank-ordered logit model for the probability of ranking each relocation scheme higher in the fairness ranking (see the Appendix).

Figure \@ref(fig:rologit-base) presents the results of the baseline rank-ordered logit model, where we assume the effect of asylum seekers does not vary by treatments. The coefficients show that proportional schemes were generally ranked as fairer, as indicated by the positive and significant intercept interactions for GDP (0.64, p<0.05) and population (0.57, p<0.05). The negative coefficient for asylum seekers (−0.35, p<0.05) suggests that schemes assigning more asylum seekers were perceived as less fair. These findings confirm our hypotheses and earlier analysis. In this regression, we don't expect strong average treatment effects, as they should have opposite signs that offset one another across countries. However, among the interaction terms, the effect of relocation by population under the control condition (0.13, p<0.05) is positive and statistically significant, indicating that fairness perceptions were on average sensitive to information about asylum seekers differences, while other interaction effects were not statistically significant.

```{r rologit-base, fig.width = 3.5, fig.height = 2.5, out.width = "0.75\\textwidth", fig.cap = cap, fig.scap = short_cap, fig.align="center"}
short_cap <- "TBA"
cap <- "Estimates and 95% CIs from a rank-ordered logit regression on the fairness rankings. $\\beta_{AS}$ represents the effect of a SD change in expected asylum seekers on the probability of ranking an allocation scheme as fairer. $\\alpha_{j}$ represents the effect of a proportional allocation mechanism $j$ relative to the no relocation alternative (omitted). This shows that only a large increase in expected asylum seekers can fully offset the baseline perception of fairness for proportional systems."

tables_rologit %>% 
    filter(relocation_treatment == "All", !grepl("info", term)) %>% 
    ggplot(
        aes(
            x = estimate, 
            y = term,
            xmin = conf.low,
            xmax = conf.high
        )
    ) + 
    geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
    geom_errorbar(width = 0.1) + 
    geom_point() + 
    scale_y_discrete(
        name = NULL,
        labels = c(
            "(Intercept):relocation_population_ranking" = expression(alpha[pop.]),
            "(Intercept):relocation_GDP_ranking" = expression(alpha[GDP]),
            "scale(asyl_skrs_rel)" = expression(beta[AS])
        )
    ) + 
    scale_x_continuous(name = "Estimates and 95% CIs", limits = c(-1, 1) * 0.75)
```

```{r coeffs}
tables_rologit %>%
    filter(relocation_treatment != "All") %>%
    mutate(
        term = gsub("^info", "", term) %>%
            gsub("relocation_(.*)_ranking", "Alt (\\1)", .) %>% 
            gsub("scale.*", "Asylum seekers (standard)", .) %>%
            dplyr::case_match(
                ., 
                .default = .,
                "(Intercept):Alt (GDP)" ~ "Relocation by GDP",
                "(Intercept):Alt (population)" ~ "Relocation by population",
                "Asylum seekers (standard)" ~ "Asylum seekers (std.)",
                "No info:Alt (GDP)" ~ "No info x reloc. by GDP",
                "No info:Alt (population)" ~ "No info x reloc. by population",
                "Relative:Alt (GDP)" ~ "Info per capita x reloc. by GDP",
                "Relative:Alt (population)" ~ "Info per capita x reloc. by population",
            )
    ) %>% 
    mutate(
        stars = dplyr::case_when(
            p.value < 0.01 ~ "***",
            p.value < 0.05 ~ "**",
            p.value < 0.1 ~ "*",
            TRUE ~ ""
        ),
        cis = sprintf("[%.1f,%.1f]", conf.low, conf.high),
        std.error = sprintf("(%.2f)", std.error),
        #estimate = sprintf("%.2f\\(^{%s}\\)", estimate, stars),
        estimate = sprintf("%.2f", estimate)
    ) %>% 
    dplyr::select(
        term, estimate, std.error, cis, relocation_treatment
    ) %>%
    tidyr::pivot_longer(
        c(estimate, std.error, cis), 
        names_to = "statistic"
    ) %>%
    tidyr::pivot_wider(
        names_from = relocation_treatment,
        values_fill = "",
    ) %>%
    dplyr::mutate(
        term = ifelse(row_number()==1, term, ""),
        .by = term 
    ) %>% 
    dplyr::rename(Coefficient = term) %>%
    dplyr::select(-statistic) %>%
    kableExtra::kbl(
        booktabs = TRUE, 
        caption = "Regression coefficients from rank-ordered logit on fairness rankings",
        align = "lcccc",
        escape = FALSE,
    ) %>%
    kableExtra::kable_styling(
        full_width = TRUE
    ) %>%
    kableExtra::column_spec(1, width = "15em") %>%
    kableExtra::footnote(
        "Standard errors in parenthesis, and 95% confidence intervals in square brackets."
    )
```

Figure \@ref(fig:rologit-ate) reports the results of the rank-ordered logit model estimated separately for each information condition, thus all coefficients to vary across the treatment conditions. Across all groups, alternatives with proportional relocation, either by GDP or by populations, were consistently ranked as fairer, with positive and significant coefficients in each condition, again confirming earlier results. However, the strength of these effects varied: the control group showed the largest by-GDP and by-population effects (0.74 and 0.75, respectively), while these effects were smaller under the absolute and relative information conditions. The negative coefficients for asylum seekers indicate that schemes allocating more asylum seekers were viewed as less fair, though the magnitude of this effect differed significantly across groups. It was strongest in the absolute-information condition (−0.57, 95% CI: -0.62, -0.52), moderate in the relative-information condition (−0.40, 95% CI: -.45, -.35), and weakest in the control group (−0.13, 95% CI: -.17, -0.08). This pattern confirms that providing information, particularly absolute information, heightened sensitivity to the number of asylum seekers when evaluating fairness. 

When considering the size of this effect, our results show that the tendency to perceive as fairer the schemes that imply fewer asylum seekers, a “self-serving” bias, does not by itself fully offset the proportional relocation effects. Indeed, as Figure 3 shows, a one SD increase in the expected asylum seekers is necessary to completely offset the proportional allocation effect, implying that a sizeable deviation is needed to favour no relocation over a proportional scheme.

```{r rologit-ate, fig.cap = cap, fig.width = 5, fig.height = 3.5, out.width = "\\textwidth"}
short_cap <- "TBA"
cap <- "Estimates and 95% CIs from separate rank-ordered logit regressions on the probability of ranking an alternative relocation scheme as fairer, under each information treatment. $\\beta_{AS}^{\\tau}$ represents the effect of a SD change in expected asylum seekers on the probability of ranking an allocation scheme as fairer, under treatment $\\tau$. $\\alpha_{j}^{\\tau}$ represents the effect of a proportional allocation mechanism $j$ relative to the no relocation alternative (omitted), under treatment $\\tau$. This shows that the effects associated with a change in expected asylum seekers (AS) are stronger under absolute than relative information. A change in AS has a significant effect on fairness rankings even under no information, indicating some awareness of respondents beyond our intervention."

dodge <- 0.5

tables_rologit %>% 
    filter(relocation_treatment != "All") %>%
    ggplot(
        aes(
            x = estimate,
            xmin = conf.low,
            xmax = conf.high,
            y = term, 
            shape = reorder(relocation_treatment, estimate),
            color = reorder(relocation_treatment, estimate),
        )
    ) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
    geom_errorbar(width = 0.1, position = position_dodge(dodge)) + 
    geom_point(position = position_dodge(dodge)) + 
    scale_shape_discrete(
        name = expression("Treatment (" ~ tau ~ ")")
    ) +
    scale_color_brewer(
        name = expression("Treatment (" ~ tau ~ ")"),
        palette = "Set1"
    ) +
    scale_x_continuous(
        name = "Coefficient and 95% CIs",
        limits = c(-1,1) * 0.85
    ) +
    scale_y_discrete(
        name = NULL,
        labels = c(
            "(Intercept):relocation_population_ranking" = expression(alpha[pop.]^tau),
            "(Intercept):relocation_GDP_ranking" = expression(alpha[GDP]^tau),
            "scale(asyl_skrs_rel)" = expression(beta[AS]^tau)
        )
    )
```

## Heterogenous effects

### Political orientation 

Figure \@ref(fig:political) illustrates that the magnitude of the information effect on perceived fairness is heavily influenced by respondents' political orientation. The figure presents the intercepts and slopes of the rank-ordered logit model discussed above for each treatment condition. Since we centered the expected number of asylum seekers for each alternative, the model's intercepts for the type of relocation (by GDP or by population) represent the average treatment effect on the probability of ranking the scheme as fairer than having no relocation at all.

Looking at the intercepts, which compare alternative schemes at the average number of asylum seekers, we find that respondents consistently assign a "premium" to relocation: the intercept is significantly greater than zero in all conditions. This premium is largest for left-leaning respondents, followed by center-leaning, and smallest for right-leaning respondents. Moreover, intercepts do not differ significantly across treatments, except in the case of relocation by population, where the Absolute condition reduces the effect of proportional relocation by population compared to no relocation. 

Conversely, we observe significant heterogeneity in the size of the effect of the provided information about expected conseuqneces of each regime (i.e., the slope). In all models, alternatives with higher numbers of asylum seekers were associated with lower fairness. However, absolute and relative information significantly amplified sensitivity to the number of asylum seekers, particularly among centre and right respondents. The differences in responses between left- and right-leaning respondents were particularly pronounced in the absolute information condition. Here, right-leaning respondents showed the strongest negative reaction to higher numbers of asylum seekers (−0.76), while left-leaning respondents were much less sensitive (−0.35), highlighting a stark partisan gap in fairness perceptions.

```{r political, fig.cap = "Political orientation", fig.asp = 1}
plot(0, 1)
#results[["political_right_cut"]]$plot
```

## Fair share 

Figure \@ref(fig:fair) illustrates the heteogeneity of the effects between individuals who reported the number of migrants in their own country as "fair" or "too low" vs those perceiving it as "too high". 

Both groups show higher perceived fairness for relocation schemes compared to no relocation, with all intercepts significantly positive. However, among respondents reporting that the current share is “fair or too low,” we do not detect a meaningful average treatment effect of framing: support is lowest under the Absolute condition, particularly for relocation by population (Estimate = 0.56, SE = 0.08) compared with GDP-based relocation (Estimate = 0.73, SE = 0.08). By contrast, in the group perceiving the share as “too high,” the Absolute framing significantly reduced support relative to Control for both GDP and population schemes (GDP: 0.29 vs. 0.61; Population: 0.38 vs. 0.65), with Relative framing falling in between and not significantly different from Control.

At the same time, for respondents reporting a “too high” share, we observe strong and significant heterogeneous effects of the expected number of asylum seekers on each relocation scheme. The negative impact of a one standard deviation increase in asylum seekers was largest under the Absolute condition (Estimate = -0.79, SE = 0.04), followed by the Relative condition (-0.56, SE = 0.04), and smallest in the Control group (-0.19, SE = 0.04). This corresponds to a difference of approximately 0.60 between Absolute and Control, substantially larger than the corresponding difference in the “fair or too low” group, which is 0.26.

```{r fair, fig.cap = cap}

cap <- "Fair share"

tbl_coeffs_hetero_raw %>%
    filter(group_var == "fair_share") %>%
    ggplot(
        aes(
            x = estimate,
            y = term,
            xmin = estimate - 1.96 * std.error,
            xmax = estimate + 1.96 * std.error,
            color = condition,
            shape = condition,
            linetype = group
        )
    ) + 
    geom_vline(xintercept = 0, color = "red") + 
    geom_errorbar(width = 0.2, position = position_dodge(.5)) + 
    geom_point(position = position_dodge(.5)) + 
    scale_shape_discrete(
        name = expression("Treat. (" ~ tau ~ ")"),
    ) + 
    scale_color_brewer(
        name = expression("Treat. (" ~ tau ~ ")"),
        palette = "Set1"
    ) + 
    scale_x_continuous(
        name = "Estimates and 95% CI"
    ) +
    scale_linetype_discrete(
        name = "Pol. Right"
    ) +
    scale_y_discrete(
        name = NULL,
        labels = c(
            "asyl_skrs_rel_scaled" = expression(beta[AS]^tau),
            "(Intercept):relocation_population_ranking" = expression(alpha[pop.]^tau),
            "(Intercept):relocation_GDP_ranking" = expression(alpha[GDP]^tau)
        )
    ) 
```

### Trust in the EU

Figure \@ref(fig:trust) illustrates ... 

```{r trust, fig.cap = "Trust in EU", out.width = "\\textwidth", fig.width = 5, fig.height=3.5}
tbl_coeffs_hetero %>% 
    filter(group_var == "trust_eu",!baseline) %>%
    ggplot(
        aes(
            x = estimate,
            y = term,
            xmin = estimate - 1.96 * std.error,
            xmax = estimate + 1.96 * std.error,
            color = condition,
            shape = condition,
            linetype = group
        )
    ) + 
    geom_vline(xintercept = 0, color = "red") + 
    #facet_grid(~group) + 
    geom_errorbar(width = 0.1, position = position_dodge(.5)) + 
    geom_point(position = position_dodge(.5)) + 
    scale_shape_discrete(
        name = expression("Treat. (" ~ tau ~ ")"),
    ) + 
    scale_color_brewer(
        name = expression("Treat. (" ~ tau ~ ")"),
        palette = "Set1"
    ) + 
    scale_x_continuous(
        name = "Estimates and 95% CI"
    ) +
    scale_linetype_discrete(
        name = "Trust EU"
    ) +
    scale_y_discrete(
        name = NULL,
        labels = c(
            "asyl_skrs_rel_scaled" = expression(alpha[AS]^tau),
            "(Intercept):relocation_population_ranking" = expression(beta[pop.]^tau),
            "(Intercept):relocation_GDP_ranking" = expression(beta[GDP]^tau)
        )
    ) + 
    coord_flip()
```

## Age

```{r}
tbl_coeffs_hetero %>% 
    filter(group_var == "age_cat",!baseline) %>%
    ggplot(
        aes(
            x = estimate,
            y = term,
            xmin = estimate - 1.96 * std.error,
            xmax = estimate + 1.96 * std.error,
            color = condition,
            shape = condition,
            linetype = group
        )
    ) + 
    geom_vline(xintercept = 0, color = "red") + 
    #facet_grid(~group) + 
    geom_errorbar(width = 0.1, position = position_dodge(.5)) + 
    geom_point(position = position_dodge(.5)) + 
    scale_shape_discrete(
        name = expression("Treat. (" ~ tau ~ ")"),
    ) + 
    scale_color_brewer(
        name = expression("Treat. (" ~ tau ~ ")"),
        palette = "Set1"
    ) + 
    scale_x_continuous(
        name = "Estimates and 95% CI"
    ) +
    scale_linetype_discrete(
        name = "Age"
    ) +
    scale_y_discrete(
        name = NULL,
        labels = c(
            "asyl_skrs_rel_scaled" = expression(alpha[AS]^tau),
            "(Intercept):relocation_population_ranking" = expression(beta[pop.]^tau),
            "(Intercept):relocation_GDP_ranking" = expression(beta[GDP]^tau)
        )
    ) + 
    coord_flip()
```

## Political right 

```{r}
tbl_coeffs_hetero_raw %>% 
    filter(group_var == "political_right") %>%
    ggplot(
        aes(
            x = estimate,
            y = term,
            xmin = estimate - 1.96 * std.error,
            xmax = estimate + 1.96 * std.error,
            color = condition,
            shape = condition,
            linetype = group
        )
    ) + 
    geom_vline(xintercept = 0, color = "red") + 
    geom_errorbar(width = 0.2, position = position_dodge(.5)) + 
    geom_point(position = position_dodge(.5)) + 
    scale_shape_discrete(
        name = expression("Treat. (" ~ tau ~ ")"),
    ) + 
    scale_color_brewer(
        name = expression("Treat. (" ~ tau ~ ")"),
        palette = "Set1"
    ) + 
    scale_x_continuous(
        name = "Estimates and 95% CI"
    ) +
    scale_linetype_discrete(
        name = "Pol. Right"
    ) +
    scale_y_discrete(
        name = NULL,
        labels = c(
            "asyl_skrs_rel_scaled" = expression(beta[AS]^tau),
            "(Intercept):relocation_population_ranking" = expression(alpha[pop.]^tau),
            "(Intercept):relocation_GDP_ranking" = expression(alpha[GDP]^tau)
        )
    ) 
```